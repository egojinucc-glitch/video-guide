name: Build and Deploy to FTP

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install gspread
      
      - name: Build site
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: python build.py
      
      # ★ 생성된 파일 목록 확인 (디버깅용)
      - name: List generated files
        run: |
          echo "=== embed 폴더 ==="
          ls -la ./site/embed/ || echo "embed 폴더 없음"
          echo "=== hub 폴더 ==="
          ls -la ./site/hub/ || echo "hub 폴더 없음"
      
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site
      
      # ★ FTP 동기화 (서버에서 없는 파일 삭제)
      - name: FTP Deploy
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./site/
          server-dir: ${{ secrets.FTP_PATH }}
          dangerous-clean-slate: true  # ★ 서버 폴더 완전 동기화
